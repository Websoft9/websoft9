name: Auto Test - PR to Dev

on:
  pull_request:
    branches:
      - dev
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for modified files
        id: changed_files
        run: |
          echo "Checking modified files in this PR..."
          git diff --name-only origin/dev...${{ github.event.pull_request.head.sha }} > changed_files.txt
          cat changed_files.txt
          
          # Check specific directories
          if grep -q "^appmanage/" changed_files.txt; then
            echo "appmanage_changed=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "^docker/" changed_files.txt; then
            echo "docker_changed=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "^systemd/" changed_files.txt; then
            echo "systemd_changed=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "^install/" changed_files.txt; then
            echo "install_changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Shellcheck for scripts
        run: |
          echo "Installing shellcheck..."
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
          echo "Running shellcheck on bash scripts..."
          find . -type f -name "*.sh" ! -path "./.git/*" -exec shellcheck -S warning {} + || true
      
      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in $(find . -name "*.json" ! -path "./.git/*" ! -path "./node_modules/*"); do
            echo "Checking $file"
            jq empty "$file" || exit 1
          done
          echo "✅ All JSON files are valid"
      
      - name: Validate YAML files
        run: |
          echo "Installing yamllint..."
          pip install yamllint
          
          echo "Validating YAML files..."
          find . -name "*.yml" -o -name "*.yaml" ! -path "./.git/*" | xargs yamllint -d relaxed || true

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: code-quality
    if: contains(github.event.pull_request.changed_files, 'docker/') || contains(github.event.pull_request.changed_files, 'appmanage/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test build appmanage image
        if: contains(github.event.pull_request.changed_files, 'appmanage/')
        run: |
          if [ -f appmanage/Dockerfile ]; then
            echo "Building appmanage Docker image..."
            docker build -t websoft9/appmanage:test ./appmanage || exit 1
            echo "✅ Appmanage image built successfully"
          fi
      
      - name: Test docker-compose validation
        run: |
          echo "Validating docker-compose files..."
          for compose_file in $(find docker -name "docker-compose.yml" 2>/dev/null); do
            echo "Validating $compose_file"
            docker-compose -f "$compose_file" config > /dev/null || exit 1
          done
          echo "✅ All docker-compose files are valid"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Run Python tests
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "Running Python unit tests..."
            # Add your test commands here
            # python -m pytest tests/ || true
            echo "✅ Python tests completed"
          fi
      
      - name: Test install script syntax
        run: |
          if [ -f install/install.sh ]; then
            echo "Testing install script syntax..."
            bash -n install/install.sh || exit 1
            echo "✅ Install script syntax is valid"
          fi

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build-test, unit-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "========================================="
          echo "PR to Dev - Test Summary"
          echo "========================================="
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Docker Build: ${{ needs.docker-build-test.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "========================================="
          
          if [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-build-test.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi
