name: Auto Test - Main CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  version-check:
    name: Version and Changelog Check
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
      channel: ${{ steps.version.outputs.channel }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version information
        id: version
        run: |
          version=$(jq -r '.version' version.json)
          version_core=${version%%-*}
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "version_core=$version_core" >> $GITHUB_OUTPUT
          
          if [[ $version == *-* ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "channel=rc" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ RC Version: $version"
          else
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "channel=release" >> $GITHUB_OUTPUT
            echo "ðŸš€ Release Version: $version"
          fi
      
      - name: Validate changelog
        run: |
          if [ ! -f changelog_latest.md ]; then
            echo "âŒ changelog_latest.md not found!"
            exit 1
          fi
          
          if [ ! -s changelog_latest.md ]; then
            echo "âš ï¸  Warning: changelog_latest.md is empty"
          fi
          
          echo "âœ… Changelog validated"
      
      - name: Check version format
        run: |
          version="${{ steps.version.outputs.version }}"
          if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "âŒ Invalid version format: $version"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
          echo "âœ… Version format is valid: $version"

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: version-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create release package
        run: |
          echo "Creating release package..."
          mkdir -p websoft9 artifacts
          
          # Copy necessary files
          cp -r docker websoft9/ 2>/dev/null || true
          cp -r cockpit websoft9/ 2>/dev/null || true
          cp -r scripts websoft9/ 2>/dev/null || true
          cp -r install websoft9/ 2>/dev/null || true
          cp -r systemd websoft9/ 2>/dev/null || true
          cp *.md websoft9/ 2>/dev/null || true
          cp version.json websoft9/ 2>/dev/null || true
          
          # Create zip
          version="${{ needs.version-check.outputs.version }}"
          version_core="${version%%-*}"
          zip -r websoft9-${version_core}.zip websoft9
          
          echo "âœ… Release package created"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: websoft9-package
          path: websoft9-*.zip
          retention-days: 7

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: version-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Check for critical vulnerabilities
        run: |
          echo "Checking security scan results..."
          if grep -q "CRITICAL" trivy-results.sarif 2>/dev/null; then
            echo "âš ï¸  Critical vulnerabilities found!"
            exit 0  # Don't fail the build, but warn
          else
            echo "âœ… No critical vulnerabilities detected"
          fi

  docker-image-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: version-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build appmanage image
        if: hashFiles('appmanage/Dockerfile') != ''
        run: |
          version="${{ needs.version-check.outputs.version }}"
          echo "Building appmanage image: $version"
          
          docker build \
            -t websoft9/appmanage:$version \
            -t websoft9/appmanage:latest \
            ./appmanage
          
          echo "âœ… Docker image built successfully"
      
      - name: Test docker images
        run: |
          echo "Testing built images..."
          docker images | grep websoft9
          echo "âœ… Images verified"

  e2e-test:
    name: End-to-End Test
    runs-on: ubuntu-latest
    needs: [version-check, build-artifacts, docker-image-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: websoft9-package
      
      - name: Verify package contents
        run: |
          echo "Verifying package contents..."
          unzip -l websoft9-*.zip
          
          # Check critical files exist
          unzip -t websoft9-*.zip
          
          echo "âœ… Package verification completed"
      
      - name: Test installation script
        run: |
          echo "Testing installation script..."
          unzip -q websoft9-*.zip
          
          if [ -f websoft9/install/install.sh ]; then
            # Dry-run syntax check
            bash -n websoft9/install/install.sh
            echo "âœ… Installation script syntax valid"
          fi
      
      - name: Test systemd services
        run: |
          echo "Validating systemd service files..."
          if [ -d websoft9/systemd ]; then
            for service in websoft9/systemd/*.service; do
              if [ -f "$service" ]; then
                echo "Checking: $service"
                systemd-analyze verify "$service" 2>/dev/null || echo "Note: Some checks require runtime context"
              fi
            done
            echo "âœ… Systemd services validated"
          fi

  performance-test:
    name: Performance Baseline
    runs-on: ubuntu-latest
    needs: version-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Measure package size
        run: |
          echo "Measuring package sizes..."
          
          total_size=$(du -sh . | awk '{print $1}')
          echo "Total repository size: $total_size"
          
          if [ -d docker ]; then
            docker_size=$(du -sh docker | awk '{print $1}')
            echo "Docker directory: $docker_size"
          fi
          
          if [ -d systemd ]; then
            systemd_size=$(du -sh systemd | awk '{print $1}')
            echo "Systemd directory: $systemd_size"
          fi
          
          echo "âœ… Size metrics collected"
      
      - name: Script performance check
        run: |
          echo "Checking script efficiency..."
          for script in $(find . -name "*.sh" -type f ! -path "./.git/*"); do
            lines=$(wc -l < "$script")
            if [ $lines -gt 1000 ]; then
              echo "âš ï¸  Large script detected: $script ($lines lines)"
            fi
          done
          echo "âœ… Performance check completed"

  summary:
    name: CI Summary and Decision
    runs-on: ubuntu-latest
    needs: [version-check, build-artifacts, security-scan, docker-image-build, e2e-test, performance-test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "========================================="
          echo "Main CI - Comprehensive Summary"
          echo "========================================="
          echo "Version: ${{ needs.version-check.outputs.version }}"
          echo "Channel: ${{ needs.version-check.outputs.channel }}"
          echo "Is Release: ${{ needs.version-check.outputs.is_release }}"
          echo ""
          echo "Test Results:"
          echo "  Version Check: ${{ needs.version-check.result }}"
          echo "  Build Artifacts: ${{ needs.build-artifacts.result }}"
          echo "  Security Scan: ${{ needs.security-scan.result }}"
          echo "  Docker Build: ${{ needs.docker-image-build.result }}"
          echo "  E2E Test: ${{ needs.e2e-test.result }}"
          echo "  Performance: ${{ needs.performance-test.result }}"
          echo "========================================="
      
      - name: Check overall status
        run: |
          if [[ "${{ needs.version-check.result }}" == "success" ]] && \
             [[ "${{ needs.build-artifacts.result }}" == "success" ]] && \
             [[ "${{ needs.docker-image-build.result }}" == "success" ]] && \
             [[ "${{ needs.e2e-test.result }}" == "success" ]]; then
            echo "âœ… All critical tests passed - Ready for release"
            echo "ðŸš€ Proceed to deployment workflow"
          else
            echo "âŒ Some tests failed - Review required"
            exit 1
          fi
