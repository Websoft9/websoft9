name: Release Deployment and Security Scan

on:
  release:
    types: [published]

jobs:
  deploy-and-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Determine release type and set channel
      id: release_type
      run: |
        if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
          echo "channel=rc" >> $GITHUB_OUTPUT
          echo "release_type=RC" >> $GITHUB_OUTPUT
        else
          echo "channel=release" >> $GITHUB_OUTPUT
          echo "release_type=Official" >> $GITHUB_OUTPUT
        fi
        
    - name: Display release info
      run: |
        echo "Processing ${{ steps.release_type.outputs.release_type }} Release"
        echo "Release Tag: ${{ github.event.release.tag_name }}"
        echo "Install Channel: ${{ steps.release_type.outputs.channel }}"
        
    - name: Download and run install script with sudo
      run: |
        wget -O install.sh https://websoft9.github.io/websoft9/install/install.sh
        sudo bash install.sh --channel ${{ steps.release_type.outputs.channel }}
        
    - name: Run CVE security scan with sudo
      run: |
        chmod +x ./scripts/cve_check.sh
        sudo ./scripts/cve_check.sh
        
    - name: Upload scan results (optional)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cve-scan-results
        path: |
          /var/log/websoft9/cve_scan.log
          /tmp/trivy_reports/
        retention-days: 30